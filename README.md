# 수술 후 요추 전만각(Post‑Surgery Lumbar Lordosis) 예측 모델

→ 수술 전 영상 및 임상 지표를 기반으로 **수술 후 요추 전만각(LL)** 을 예측하는 머신러닝 회귀 모델입니다.

본 저장소에는 서로 다른 손실 체계를 사용하는 두 가지 버전이 포함됩니다.

* **RMSE 모델 (기존 버전)** — Huber/Log‑cosh/MSE 조합
* **MAE 모델 (개선 버전)** — L1Loss(MAE) 일원화

> **성능 선택 원칙:** 두 모델의 테스트 결과에서 **Test LL_post 오차(=최종 DLL 지표)** 가 **더 낮은 실험**을 현재 기준 최적 성능으로 채택합니다.

---

## 1. 모델 개요

두 버전 모두 **공유 MLP 백본(Shared MLP Backbone)** 을 중심으로 두 개의 출력 헤드를 사용합니다.

* **ΔSL Head (5채널):** 각 요추 레벨별 Segmental Lordosis( SL₁~SL₅ )의 **변화량(ΔSL)** 예측
* **ΔLL_aux Head (1채널):** 전체 LL 변화량(ΔLL)을 보조적으로 예측 (일관성 제약에 사용)

**출력 계산식**

```
SL_post_pred = ΔSL + SL_pre
LL_post_pred = ΣΔSL + LL_pre
```

---

## 2. 입력 특징 (Input Features)

* **Segment‑level features (5×12 = 60차원)**
  SL_pre, 수술 접근법(op_tlif, op_plif, op_olif, op_alif),
  Cage 크기(cage_w, cage_l, cage_h, cage_d),
  Cage 위치(cagepos_anterior, cagepos_center, cagepos_posterior)

* **Global features (4차원)**
  Age, BMI, Sex(0/1), SS_pre
  → 총 **64차원 입력**

---

## 3. 모델 구조 (백본/헤드)

![Uploading 스크린샷 2025-11-12 오후 2.30.27.png…]()

> **모든 hidden 노드 수는 64**, **Dropout=0.1** 로 통일.

| 구성 요소   | 내용                                                                                                                                     |
| ------- | -------------------------------------------------------------------------------------------------------------------------------------- |
| 입력 차원   | 64                                                                                                                                     |
| 백본      | Linear(64→64) → ReLU → Dropout(0.1) → Linear(64→64) → ReLU → Dropout(0.1) → Linear(64→64) → ReLU → Dropout(0.1) → Linear(64→64) → ReLU |
| 출력 헤드   | ΔSL Head: Linear(64→5), ΔLL_aux Head: Linear(64→1)                                                                                     |
| 활성화 함수  | ReLU                                                                                                                                   |
| 가중치 초기화 | Xavier(Glorot) uniform                                                                                                                 |
| 입력 정규화  | z‑score (표준편차 0일 경우 1.0 대체)                                                                                                            |

---

## 4. 학습 설정 (공통)

| 항목                | 값                                                   |
| ----------------- | --------------------------------------------------- |
| Optimizer         | AdamW (lr=0.001, weight_decay=1e‑4)                 |
| Batch Size        | 64                                                  |
| Epochs            | 최대 1000 (EarlyStopping: patience=50, min_delta=0.1) |
| Gradient Clipping | 5.0                                                 |
| Dropout           | **0.1**                                             |
| λ (Segment 가중치)   | [0.133, 0.114, 0.197, 0.208, 0.348]                 |

> 각 버전은 동일한 데이터 분할/전처리 체계를 공유하며, 조기 종료는 **검증 total loss** 기준으로 수행합니다.

---

## 5. 손실 구성 (버전별)

| 항목          | **RMSE 모델**                                            | **MAE 모델**                                             |
| ----------- | ------------------------------------------------------ | ------------------------------------------------------ |
| SL 손실       | SmoothL1Loss(**Huber**)                                | **L1Loss (MAE)**                                       |
| LL 손실       | **log‑cosh**                                           | **L1Loss (MAE)**                                       |
| Consistency | **MSE**(dll_aux vs dll_sum.detach)                     | **L1Loss (MAE)**(dll_aux vs dll_sum.detach)            |
| TV(인접 스무딩)  | (옵션) ΔSL 차이 제곱 평균                                      | (옵션) ΔSL 차이 제곱 평균                                      |
| 가중치(예시)     | L_total = 0.65·L_SL + 0.30·L_LL + 0.05·L_cons + 0·L_tv | L_total = 0.65·L_SL + 0.30·L_LL + 0.05·L_cons + 0·L_tv |

> TV 항은 실험에 따라 0이 아닌 값으로 조정할 수 있으나, 본 베이스라인은 0으로 고정했습니다.

---

## 6. 성능 요약 (LL_post 기준, Test)

> 아래 값은 각 버전의 결과 CSV에서 **LL_post 최종 오차**를 취해 요약한 것입니다.
> (선정 규칙: **더 낮은 LL_post 오차** → 더 우수)

| 모델          | 지표               | **최종 Test LL_post 오차** | 비고          |
| ----------- | ---------------- | ------------------: | ----------- |
| **RMSE 모델** | **RMSE_LL_post** |           **7.44°** | 사용 지표: RMSE |
| **MAE 모델**  | **MAE_LL_post**  |           **6.26°** | 사용 지표: MAE  |


---

## 7. 세부 결과 (MAE 모델, 예시 실험)

| 항목                     | 결과                                  |
| ---------------------- | ----------------------------------- |
| **Test MAE (LL_post)** | **6.26°**                           |
| Test MAE (SL_post_ALL) | 3.50°                               |
| Segment별 MAE (SL₁~SL₅) | [2.67°, 2.72°, 3.66°, 3.72°, 4.73°] |
| Test Total Loss        | 4.195                               |
| Best Validation Loss   | 4.499                               |

---

## 8. RMSE → MAE 전환 이유

MAE 모델은 단순히 수치가 낮기 때문이 아니라, **척추 각도 예측 문제의 구조적 특성과 임상적 해석 방식에 부합하기 때문에** 채택되었습니다.

1. **임상적 일관성** — 의료 현장에서는 ‘예측이 몇 도 틀렸는가’가 핵심입니다. 각도 오차의 절댓값이 곧 의미 있는 수치이므로, MAE가 RMSE보다 직접적이고 직관적인 해석을 제공합니다.
2. **이상치(Outlier)에 대한 안정성** — X-ray 촬영 오차나 비정상 케이스가 존재하기 때문에, 제곱오차 기반 RMSE는 일부 큰 오차에 과도하게 민감해집니다. MAE는 모든 샘플에 균등 가중치를 부여하여, 보다 **현실적이고 강건한 평가**를 제공합니다.
3. **모델 구조와의 정합성** — 본 모델은 ΔSL·ΔLL consistency를 동시에 학습하는 multi-head 회귀 구조로, 전체적인 방향성과 일관성이 중요합니다. L1 기반 MAE 손실은 이러한 구조적 학습 목표와 더 잘 맞아 안정적인 수렴을 유도합니다.

---

## 9. X‑ray 촬영 각도 문제 및 평가 정책

* **문제 인식:** 일부 X‑ray 데이터에서 **촬영 자세 차이**로 인해 수술 전후 동일한 뼈 구조의 실제 각도가 달라지는 현상이 발견되었습니다.
* **수치화:** 이 차이를 각도 단위로 정량화한 결과, 각 절댓값을 취해 평균을 냈을 때 **5.19°** 의 촬영 자세 차이가 존재함을 확인했습니다.
* **보정 시도:** 해당 값을 RMSE 결과(7.44°)에서 단순 차감할 경우 **2.2°**의 결과가 도출되지만, 절댓값 평균은 오차의 **방향성(부호)** 정보를 제거하기 때문에 **잘못된 방법**임이 확인되었습니다.
* **정상 평균 기준:** 부호를 포함해 평균을 낸 결과는 약 **0.8°** 수준으로, 절댓값 기반 보정보다 훨씬 작은 값입니다.
* **최종 결론:** 따라서 **2.2°라는 결과는 사용하지 않으며**, 모든 모델 평가는 **원본 측정값 기준 오차(LL_post MAE/RMSE)** 로 산출됩니다.

**평가 정책 요약**

1. 촬영각도 보정(절댓값 필터링) **미적용**
2. 모든 결과는 **원본 측정값 기준**의 MAE/RMSE로 계산
3. 촬영 오차 문제는 **향후 데이터 수집/분석** 단계에서 별도로 통제 예정

---
